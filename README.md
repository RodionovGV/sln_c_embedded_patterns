# 
Применение шаблонов программирования по мотивам книги: [Adam Tornhill ](https://www.adamtornhill.com/)Patterns in C.
Хранилище кода по книге на [git](https://github.com/adamtornhill/PatternsInC).


# State
ptrn_state_adt - Машина состояния реализованая с помощью ADT шаблона.
- состояния должны не зависеть от полезной нагрузки для состояний.
- простое расширение состояний.
- тестирование на железе.

### Semaforo
il semaforo по итальянски светофор.

#### Алгоритм применения шаблона на основе Semaforo.
_implement.c - файл применения машины состояния.
_implemen.h - прототипы для запуска машины состояния, скрытой от пользователя.
    здесь же привязка сторонних зависимостией - аппаратных и др. для машины состояний. Общение состояний реализовано через callbackи `.on_entry`, `.on_do`, `.on_exit`, `.check_change_state` - первые три классические для машины состояния - действия: при первом вхождении, при выполнении каждый раз, при выходе. Показано как получить время работы с помощью функции getWorkTicks.

_default.c - функции по умолчанию, когда работаем в конкретном состоянии, другие состояния выполняются пустыми функциями из default.
_default.h - прототип функции установки состояний по умолчанию, стурутура состояния с callback для вхождения, выполнения и выхода + дополнительные, если нужно.

_internal.h - прототипы состояний, структура список всех состояний машины состояния. Дополнительные структуры для состояния.

state_XXX.c - функции состояния. Главная функция состояния и функции перехода в это состояние.
state_XXXX.h - прототип функции перехода в это состояния. Подключается к состояниям из которых возможен переход в данное состояние.

state_pattern.c - шаблон состояния.
stae_pattern.h - шаблон состояния.
1. Скопировать файлы шаблона state_pattern.c, state_pattern.h. Перименовать с именем состояния.
2. Изменить в state_[new].h объявление файла и прототип перехода.
3. Выполнить изменения в state_[new].c имя функции перехода и имя главной функции состояния.
4. В функции перехода изменить имя состояния для текущего рабочего состояния.
5. Внести новое состояние в _internal.h добавить тип callback для состояния и состояние в список состояний.
6. Добавить в состояния из которых будет переход в состоянияе state_[new].c заголовочный файл state_[new].h и вызвать функцию transitionToXXX, если нужно событие, то прописать событие.
7. Добавить в _implement.c функцию обёртку для состояния с объявлением событий и присвоения функция `.on_entry` и пр.
8. Вызвать функцию обёртки в функции машины состояния.

#### Разработка
1. Отсчёт времени работы в состоянии. Нужно точная работа в заданном состоянии.
    Сейчас на одном кадре выполнения считается выход из состояния и вход в состояние.
2. Задание настроек работы через структуру events.

Алгоритм
Зелёный 15-60 с.
Мигающий зелёный 3 мигания T=1c.
Желтый 3-4 с
Красный 30 с.
Красный + Желтый 1-2с
